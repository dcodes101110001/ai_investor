# ============================================================================
# SimFin Data Download Workflow
# ============================================================================
# 
# PURPOSE:
#   Automatically downloads financial data from SimFin API and commits it
#   to a dedicated branch (data-updates) for review and merging.
# 
# SCHEDULE:
#   Runs daily at 2 AM UTC (automatic)
#   Can also be triggered manually via workflow_dispatch
# 
# REQUIRED SECRETS:
#   1. SIMFIN_API_KEY (required)
#      - Your SimFin API key for data access
#      - Get it from: https://simfin.com/
# 
#   2. GIT_PAT (required for public forks)
#      - Personal Access Token with 'repo' and 'workflow' scopes
#      - Required for pushing Git LFS data to public forks
#      - Setup instructions in the "Setup Personal Access Token" step below
#      - Alternative: Use SSH_DEPLOY_KEY (see WORKFLOW_AUTHENTICATION_SETUP.md)
# 
# OPTIONAL CONFIGURATION:
#   - DATA_BRANCH variable: Custom branch name (default: data-updates)
#   - USE_SSH_AUTH variable: Set to 'true' to use SSH instead of PAT
# 
# DOCUMENTATION:
#   - Full setup guide: WORKFLOW_AUTHENTICATION_SETUP.md
#   - Git LFS setup: GIT_LFS_INTEGRATION.md
#   - Troubleshooting: WORKFLOW_FIX_DOCUMENTATION.md
# 
# ============================================================================

name: Download SimFin Data

# Run daily at 2 AM UTC
on:
  schedule:
    - cron: '0 2 * * *'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  download-data:
    name: Download SimFin Financial Data
    runs-on: ubuntu-latest
    
    # Grant write permissions to commit and push data changes
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone to reduce checkout time and data transfer
          lfs: true  # Enable Git LFS for large file handling
      
      - name: Configure Git LFS
        run: |
          echo "Configuring Git Large File Storage (LFS)..."
          git lfs install
          echo "âœ“ Git LFS installed and configured"
          
          # Verify LFS is working
          git lfs version
          echo "âœ“ Git LFS version verified"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Verify stock_data directory
        run: |
          echo "Checking if stock_data directory exists..."
          if [ ! -d "stock_data" ]; then
            echo "stock_data directory does not exist. Creating it..."
            mkdir -p stock_data
            echo "âœ“ stock_data directory created"
          else
            echo "âœ“ stock_data directory already exists"
          fi
          ls -la stock_data/ || echo "Directory is empty"
      
      - name: Install dependencies
        run: |
          echo "Installing Python dependencies..."
          python -m pip install --upgrade pip
          pip install simfin
          echo "âœ“ Dependencies installed successfully"
      
      - name: Download SimFin data
        env:
          SIMFIN_API_KEY: ${{ secrets.SIMFIN_API_KEY }}
        run: |
          echo "Starting SimFin data download..."
          python scripts/download_simfin_data.py
        continue-on-error: false
      
      - name: Verify downloaded data
        run: |
          echo "Verifying downloaded data files..."
          echo "Contents of stock_data directory:"
          ls -lh stock_data/ || echo "No files found in stock_data directory"
          
          # Count the number of files
          file_count=$(find stock_data -type f -name "*.csv" 2>/dev/null | wc -l)
          echo "Number of CSV files downloaded: $file_count"
          
          if [ "$file_count" -eq 0 ]; then
            echo "âš ï¸ Warning: No CSV files were downloaded"
            echo "Possible causes:"
            echo "  - Invalid or missing SIMFIN_API_KEY secret"
            echo "  - Network connectivity issues"
            echo "  - SimFin API service unavailable"
            echo "  - API rate limit exceeded"
            exit 1
          else
            echo "âœ“ Download verification successful"
          fi
      
      - name: Verify Git LFS tracking
        run: |
          echo "Verifying Git LFS file tracking..."
          
          # Check if CSV files exist to track
          if [ -d stock_data/ ] && [ -n "$(find stock_data -name '*.csv' -print -quit)" ]; then
            echo "Files in stock_data that will be tracked by LFS:"
            git lfs track 2>/dev/null || echo "Git LFS tracking patterns:"
            cat .gitattributes | grep "\.csv"
            
            # Show which files will be tracked by LFS
            echo ""
            echo "CSV files that match LFS patterns:"
            find stock_data -name "*.csv" 2>/dev/null | head -10 || echo "No CSV files yet"
            
            echo "âœ“ Git LFS tracking configuration verified"
          else
            echo "âš ï¸ No files to track yet"
          fi
      
      - name: Configure Git
        run: |
          echo "Configuring Git for automated commits..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Git LFS configuration for better performance
          git config --global lfs.concurrenttransfers 10
          git config --global lfs.transfer.maxretries 3
          
          # Increase buffer size to handle large payloads (150MB)
          git config --global http.postBuffer 157286400
          
          # Configure timeout settings for better reliability
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 60
          
          echo "âœ“ Git configured successfully"
      
      - name: Clean up intermediate files
        run: |
          echo "Cleaning up intermediate download files..."
          
          # Remove ZIP files - they are intermediate files that are not needed in version control
          # The CSV files extracted from these ZIPs are the actual data we want to track
          if [ -d "stock_data" ]; then
            # Count ZIP files before removal
            zip_count=$(find stock_data -type f -name "*.zip" 2>/dev/null | wc -l)
            
            if [ "$zip_count" -gt 0 ]; then
              echo "Found $zip_count ZIP file(s) to remove"
              find stock_data -type f -name "*.zip" -delete
              echo "âœ“ ZIP files removed (CSV files retained)"
            else
              echo "No ZIP files found - nothing to clean up"
            fi
            
            # Show what will be committed
            echo ""
            echo "Files that will be tracked in version control:"
            find stock_data -type f -name "*.csv" 2>/dev/null | head -10 || echo "No CSV files found"
          else
            echo "âš ï¸ stock_data directory does not exist"
          fi
      
      - name: Check for changes
        id: check_changes
        run: |
          echo "Checking for changes in stock_data directory..."
          
          # Verify directory exists before attempting git operations
          if [ ! -d "stock_data" ]; then
            echo "âš ï¸ stock_data directory does not exist"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git add stock_data/
          
          if git diff --staged --quiet; then
            echo "No changes detected in stock_data directory"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ“ Changes detected in stock_data directory"
            echo "Modified/added files:"
            git diff --staged --name-status
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # SSH DEPLOY KEY AUTHENTICATION (ALTERNATIVE TO PAT)
      # ===================================================
      # This step configures SSH-based authentication as an alternative to PAT.
      # SSH keys are more secure for production use as they're repository-specific.
      # 
      # TO USE SSH AUTHENTICATION:
      # 1. Create an SSH key pair (see WORKFLOW_AUTHENTICATION_SETUP.md)
      # 2. Add public key as Deploy Key in repository settings (with write access)
      # 3. Add private key as SSH_DEPLOY_KEY secret
      # 4. Set USE_SSH_AUTH=true in repository variables
      # 
      # This step only runs if USE_SSH_AUTH variable is set to 'true'
      # Otherwise, the workflow uses GIT_PAT (see "Setup Personal Access Token" step below)
      # 
      - name: Setup SSH Deploy Key (if available)
        if: steps.check_changes.outputs.has_changes == 'true' && vars.USE_SSH_AUTH == 'true'
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
        run: |
          if [ -n "$SSH_PRIVATE_KEY" ]; then
            echo "âœ“ SSH_DEPLOY_KEY secret found"
            echo "Setting up SSH authentication..."
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            
            # Add the private key
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            
            # Add GitHub to known hosts
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
            
            # Configure Git to use SSH
            git remote set-url origin git@github.com:${{ github.repository }}.git
            
            echo "âœ“ SSH authentication configured successfully"
          else
            echo "âŒ ERROR: USE_SSH_AUTH is enabled but SSH_DEPLOY_KEY secret not found"
            echo ""
            echo "To fix this issue, choose one of these options:"
            echo "  1. Add SSH_DEPLOY_KEY secret (see WORKFLOW_AUTHENTICATION_SETUP.md)"
            echo "  2. Disable SSH authentication:"
            echo "     â†’ Go to: Repository Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab"
            echo "     â†’ Find 'USE_SSH_AUTH' and delete it (or set value to 'false')"
            echo "     â†’ Then add GIT_PAT secret instead"
            echo ""
            exit 1
          fi
      
      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Committing changes to repository..."
          current_date=$(date -u +"%Y-%m-%d %H:%M:%S")
          
          # Define the target branch for data updates
          TARGET_BRANCH="${{ vars.DATA_BRANCH || 'data-updates' }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          
          echo "Current branch: $CURRENT_BRANCH"
          echo "Target branch for data updates: $TARGET_BRANCH"
          
          # Create or checkout the data updates branch
          if git show-ref --verify --quiet "refs/remotes/origin/$TARGET_BRANCH"; then
            echo "Checking out existing branch: $TARGET_BRANCH"
            git fetch origin "$TARGET_BRANCH"
            # Use -B to create or reset the branch to track origin
            git checkout -B "$TARGET_BRANCH" "origin/$TARGET_BRANCH"
            # Merge changes from current branch
            # Using -X theirs strategy: In case of conflicts, prefer incoming changes
            # This is safe because we're merging automated data downloads
            git merge --no-edit "$CURRENT_BRANCH" -X theirs || {
              echo "âš ï¸ Merge conflict detected"
              echo "Aborting merge and using current branch state"
              git merge --abort
              git checkout -B "$TARGET_BRANCH"
            }
          else
            echo "Creating new branch: $TARGET_BRANCH"
            git checkout -b "$TARGET_BRANCH"
          fi
          
          # Commit the changes
          git commit -m "chore: update SimFin data - $current_date UTC"
          echo "âœ“ Changes committed successfully to branch: $TARGET_BRANCH"
      
      # AUTHENTICATION SETUP FOR GIT PUSH WITH LFS
      # ============================================
      # This step configures authentication for pushing changes to the repository.
      # 
      # WHY IS THIS NEEDED?
      # - This is a PUBLIC FORK, and GitHub restricts Git LFS uploads from forks using the default GITHUB_TOKEN
      # - Error without proper auth: "@github-actions[bot] can not upload new objects to public fork"
      # - The downloaded data files (~400MB+) are tracked by Git LFS and require elevated permissions
      # 
      # REQUIRED: GIT_PAT SECRET
      # ---------------------------
      # You MUST create a Personal Access Token (PAT) with the following scopes:
      #   âœ“ repo (Full control of private repositories)
      #   âœ“ workflow (Update GitHub Action workflows)
      # 
      # HOW TO SET UP THE GIT_PAT SECRET:
      # 1. Create a Personal Access Token:
      #    - Go to: https://github.com/settings/tokens
      #    - Click "Generate new token" â†’ "Generate new token (classic)"
      #    - Token name: "GitHub Actions Workflow Data Upload"
      #    - Select scopes: âœ“ repo, âœ“ workflow
      #    - Set expiration (recommended: 90 days)
      #    - Click "Generate token" and COPY IT (you won't see it again!)
      # 
      # 2. Add the token as a repository secret:
      #    - Go to: Repository Settings â†’ Secrets and variables â†’ Actions
      #    - Click "New repository secret"
      #    - Name: GIT_PAT
      #    - Value: Paste your Personal Access Token
      #    - Click "Add secret"
      # 
      # 3. Re-run this workflow
      # 
      # ALTERNATIVE: SSH Deploy Key (see WORKFLOW_AUTHENTICATION_SETUP.md)
      # -------------------------------------------------------------------
      # For enhanced security, you can use an SSH deploy key instead of PAT.
      # Set USE_SSH_AUTH=true in repository variables and configure SSH_DEPLOY_KEY secret.
      # See the "Setup SSH Deploy Key" step above for SSH configuration.
      # 
      - name: Setup Personal Access Token (if SSH not used)
        if: steps.check_changes.outputs.has_changes == 'true' && vars.USE_SSH_AUTH != 'true'
        env:
          GIT_PAT: ${{ secrets.GIT_PAT }}
        run: |
          if [ -n "$GIT_PAT" ]; then
            echo "âœ“ GIT_PAT secret found"
            echo "Setting up Personal Access Token authentication..."
            
            # Configure Git to use the PAT for authentication
            # Format: https://x-access-token:TOKEN@github.com/OWNER/REPO.git
            # Note: GitHub automatically masks the token in logs for security
            git remote set-url origin "https://x-access-token:${GIT_PAT}@github.com/${{ github.repository }}.git"
            
            echo "âœ“ Personal Access Token configured successfully"
            echo "âœ“ Authentication ready for Git LFS push operations"
          else
            echo "âŒ ERROR: GIT_PAT secret not found!"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  AUTHENTICATION REQUIRED FOR GIT LFS ON PUBLIC FORKS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "This workflow cannot push Git LFS data without proper authentication."
            echo "The default GITHUB_TOKEN has insufficient permissions on public forks."
            echo ""
            echo "Please set up a GIT_PAT secret with the following scopes:"
            echo "  â€¢ repo (Full control of private repositories)"
            echo "  â€¢ workflow (Update GitHub Action workflows)"
            echo ""
            echo "Quick Setup Guide:"
            echo "-------------------"
            echo "1. Create Personal Access Token:"
            echo "   â†’ Visit: https://github.com/settings/tokens"
            echo "   â†’ Click: Generate new token (classic)"
            echo "   â†’ Select scopes: repo + workflow"
            echo "   â†’ Copy the generated token"
            echo ""
            echo "2. Add as Repository Secret:"
            echo "   â†’ Go to: Repository Settings â†’ Secrets and variables â†’ Actions"
            echo "   â†’ Click: New repository secret"
            echo "   â†’ Name: GIT_PAT"
            echo "   â†’ Value: (paste your token)"
            echo ""
            echo "3. Re-run this workflow"
            echo ""
            echo "For detailed instructions, see: WORKFLOW_AUTHENTICATION_SETUP.md"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            exit 1
          fi
      
      # VALIDATE AUTHENTICATION BEFORE PUSH
      # ====================================
      # This step verifies that proper authentication is configured before attempting to push.
      # It prevents wasting time on failed push attempts and provides clear error messages.
      - name: Validate authentication setup
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GIT_PAT: ${{ secrets.GIT_PAT }}
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
          USE_SSH: ${{ vars.USE_SSH_AUTH }}
        run: |
          echo "Validating authentication configuration..."
          echo ""
          
          # Check if SSH authentication is configured
          if [ "$USE_SSH" == "true" ]; then
            if [ -n "$SSH_DEPLOY_KEY" ]; then
              echo "âœ“ SSH Deploy Key authentication configured"
              exit 0
            else
              # This should rarely happen as the SSH setup step would have failed earlier
              echo "âŒ ERROR: USE_SSH_AUTH is enabled but SSH_DEPLOY_KEY secret not found"
              echo "The 'Setup SSH Deploy Key' step should have caught this earlier."
              exit 1
            fi
          fi
          
          # Check if PAT authentication is configured
          if [ -n "$GIT_PAT" ]; then
            echo "âœ“ Personal Access Token (GIT_PAT) configured"
            echo "âœ“ Ready to push with elevated permissions"
            exit 0
          fi
          
          # No valid authentication found
          echo "âŒ ERROR: No valid authentication configured!"
          echo ""
          echo "This workflow requires either:"
          echo "  1. GIT_PAT secret (recommended for public forks)"
          echo "  2. SSH_DEPLOY_KEY secret + USE_SSH_AUTH=true variable"
          echo ""
          echo "The default GITHUB_TOKEN cannot push Git LFS data to public forks."
          echo "See the 'Setup Personal Access Token' step above for setup instructions."
          echo ""
          exit 1
      
      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Pushing changes to remote repository with Git LFS..."
          
          # Get the target branch name
          TARGET_BRANCH="${{ vars.DATA_BRANCH || 'data-updates' }}"
          
          # Verify LFS objects are ready
          echo "Checking Git LFS status..."
          git lfs status || echo "No LFS objects yet"
          
          # Display what will be pushed
          echo ""
          echo "Files to be pushed:"
          git diff --stat HEAD~1 2>/dev/null || git diff --stat --cached || echo "No diff available"
          echo ""
          
          # Push with retry logic to handle transient network issues
          max_attempts=3
          attempt=1
          # Use unique temp file to avoid conflicts with concurrent runs
          push_error_log="/tmp/git_push_error_${{ github.run_id }}.log"
          
          while [ $attempt -le $max_attempts ]; do
            echo "Push attempt $attempt of $max_attempts..."
            echo "Pushing to branch: $TARGET_BRANCH"
            
            # Push commits and LFS objects to the data updates branch
            # Capture both stdout and stderr for better error diagnosis
            if git push origin "$TARGET_BRANCH" 2>&1 | tee "$push_error_log"; then
              echo "âœ“ Changes pushed successfully to branch: $TARGET_BRANCH"
              echo ""
              echo "Summary:"
              echo "  - Data downloaded and committed"
              echo "  - Branch: $TARGET_BRANCH"
              echo "  - Commit: $(git rev-parse HEAD)"
              echo ""
              echo "ðŸ“ Note: Changes are on the '$TARGET_BRANCH' branch"
              echo "   You can review and merge these changes into your main branch when ready."
              
              # Show LFS transfer summary if applicable
              echo ""
              echo "Git LFS transfer summary:"
              git lfs ls-files -s 2>/dev/null | head -10 || echo "No LFS files tracked yet"
              
              exit 0
            else
              # Capture the exit code
              push_exit_code=$?
              echo "âš ï¸ Push attempt $attempt failed with exit code: $push_exit_code"
              
              # Check if it's the known LFS fork restriction error
              if grep -q "can not upload new objects to public fork" "$push_error_log" 2>/dev/null; then
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "  DETECTED: Git LFS Public Fork Restriction"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "GitHub prevents Git LFS uploads to public forks for security."
                echo "This is a known limitation, not a credentials issue."
                echo ""
                echo "Files causing the issue:"
                git lfs ls-files 2>/dev/null || echo "No LFS files detected"
                echo ""
                echo "DIAGNOSIS:"
                echo "----------"
                echo "âœ“ Authentication appears correct (GIT_PAT is configured)"
                echo "âœ— Git LFS is attempting to upload files to a public fork"
                echo "âœ— GitHub blocks LFS uploads to public forks even with valid PAT"
                echo ""
                echo "RECOMMENDED SOLUTIONS:"
                echo "---------------------"
                echo "1. Remove large files from Git LFS tracking:"
                echo "   - Check .gitattributes for patterns tracking unwanted files"
                echo "   - Add large files (e.g., *.zip) to .gitignore instead"
                echo "   - Only track essential data files with LFS"
                echo ""
                echo "2. Alternative: Make repository private (if acceptable)"
                echo "   - Go to Settings â†’ Danger Zone â†’ Change visibility"
                echo "   - This removes the fork restriction"
                echo ""
                echo "3. Use artifacts instead of Git for large data:"
                echo "   - Data is already uploaded as workflow artifacts"
                echo "   - Available for 30 days in Actions tab"
                echo ""
                exit 1
              fi
              
              if [ $attempt -lt $max_attempts ]; then
                wait_time=$((attempt * 10))
                echo "Waiting ${wait_time} seconds before retry..."
                sleep $wait_time
                attempt=$((attempt + 1))
              else
                echo "âŒ Failed to push changes after $max_attempts attempts"
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "  PUSH FAILED: AUTHENTICATION OR PERMISSIONS ISSUE"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "Error details from git push:"
                cat "$push_error_log" 2>/dev/null || echo "No error log available"
                echo ""
                echo "Common causes:"
                echo "  â€¢ Missing or invalid GIT_PAT secret"
                echo "  â€¢ PAT lacks required scopes (repo, workflow)"
                echo "  â€¢ PAT has expired"
                echo "  â€¢ Network connectivity issues"
                echo "  â€¢ Git LFS quota exceeded"
                echo "  â€¢ Branch protection rules blocking push"
                echo ""
                echo "If you see: '@github-actions[bot] can not upload new objects'"
                echo "  â†’ This means GIT_PAT is not configured or invalid"
                echo ""
                echo "SOLUTION:"
                echo "----------"
                echo "1. Verify GIT_PAT secret exists:"
                echo "   â†’ Repository Settings â†’ Secrets and variables â†’ Actions"
                echo "   â†’ Should see 'GIT_PAT' in the list"
                echo ""
                echo "2. If missing, create a new Personal Access Token:"
                echo "   â†’ Visit: https://github.com/settings/tokens"
                echo "   â†’ Generate new token (classic)"
                echo "   â†’ Select scopes: âœ“ repo, âœ“ workflow"
                echo "   â†’ Add as GIT_PAT secret in repository settings"
                echo ""
                echo "3. If exists but failing, check:"
                echo "   â†’ Token hasn't expired (check expiration date)"
                echo "   â†’ Token has 'repo' and 'workflow' scopes"
                echo "   â†’ No typos when copying/pasting the token"
                echo ""
                echo "For detailed setup instructions:"
                echo "  â†’ See: WORKFLOW_AUTHENTICATION_SETUP.md in this repository"
                echo ""
                echo "Alternative: Use SSH Deploy Key"
                echo "  â†’ See: WORKFLOW_AUTHENTICATION_SETUP.md (Method 1)"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                exit 1
              fi
            fi
          done
      
      - name: Upload data as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: simfin-data-${{ github.run_number }}
          path: stock_data/
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          # Get the target branch name
          TARGET_BRANCH="${{ vars.DATA_BRANCH || 'data-updates' }}"
          
          echo "## SimFin Data Download Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Source Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** $TARGET_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "stock_data" ]; then
            echo "### Downloaded Files" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh stock_data/ 2>/dev/null || echo "No files" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ stock_data directory not found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add Git LFS information
          echo "### Git LFS Status" >> $GITHUB_STEP_SUMMARY
          if git lfs ls-files 2>/dev/null | grep -q .; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git lfs ls-files >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "No files tracked by LFS yet" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add commit status information
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "### Git Status" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Changes committed and pushed to repository**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Branch: \`$TARGET_BRANCH\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Latest commit: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Authentication Method" >> $GITHUB_STEP_SUMMARY
            if [ "${{ vars.USE_SSH_AUTH }}" == "true" ]; then
              echo "ðŸ” SSH Deploy Key (more secure)" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ”‘ Personal Access Token or GITHUB_TOKEN" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Git Status" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ No changes detected (data already up-to-date)" >> $GITHUB_STEP_SUMMARY
          fi
